<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>终末地 · 基质蚀刻工具</title>
  <!-- 技术栈CDN引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind自定义主题配置：武器星级配色 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              900: '#121C2D',
              800: '#1E293B',
              100: '#F8FAFC',
            },
            secondary: {
              200: '#E2E8F0',
              100: '#F1F5F9',
            },
            accent: {
              main: '#E64A19',
              sub: '#FF9800',
              skill: '#2196F3',
              weapon6: '#E53E3E', // 六星武器：火焰红
              weapon5: '#DAA520', // 五星武器：金黄色
              btn: '#2563EB'      // 按钮主色
            },
            text: {
              primary: '#2D3748',
              secondary: '#718096',
              disabled: '#A0AEC0'
            }
          },
          fontFamily: {
            title: ['Montserrat', 'Noto Sans SC', 'sans-serif'],
            sans: ['Noto Sans SC', 'sans-serif'],
          },
          spacing: {
            1: '4px', 0.5: '2px',
            2: '8px', 3: '12px',
            4: '16px', 5: '20px',
            6: '24px', 8: '32px',
            10: '40px',
          },
          fontSize: {
            xs: '12px',
            sm: '14px',
            base: '16px',
            lg: '18px',
            xl: '20px',
            '2xl': '24px',
          },
          lineHeight: {
            'base': 1.5,
            'title': 1.2,
          },
          borderRadius: {
            frame: '20px',
            card: '8px',
            sm: '4px',
            btn: '6px'
          },
          boxShadow: {
            frame: '0 0 30px rgba(0,0,0,0.3)',
            card: '0 2px 8px rgba(0,0,0,0.08)',
            hover: '0 4px 12px rgba(0,0,0,0.12)',
            btn: '0 2px 4px rgba(37,99,235,0.2)'
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .text-balance { text-wrap: balance; }
      .content-auto { content-visibility: auto; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      
      .section-title {
        @apply font-title font-bold text-xl text-text-primary mb-4 leading-title;
      }
      .card-title {
        @apply font-title font-semibold text-lg text-primary-800 mb-3 leading-title;
      }
      .strategy-title {
        @apply font-semibold text-base text-primary-800 mb-3 flex items-center gap-2;
      }
      
      .tag-main { @apply font-medium text-accent-main; }
      .tag-sub { @apply font-medium text-accent-sub; }
      .tag-skill { @apply font-medium text-accent-skill; }
      .weapon-6 { @apply font-medium text-accent-weapon6; } /* 六星武器样式 */
      .weapon-5 { @apply font-medium text-accent-weapon5; } /* 五星武器样式 */
      
      .custom-select {
        @apply w-full py-3 px-4 border border-secondary-200 rounded-sm bg-white 
               text-base text-text-primary focus:outline-none focus:ring-2 
               focus:ring-accent-main/30 focus:border-accent-main 
               transition-all duration-200 appearance-none relative;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%232D3748' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
      }
      .custom-select:disabled {
        @apply bg-secondary-100 border-secondary-200 text-text-disabled cursor-not-allowed;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23A0AEC0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      }
      
      .custom-btn {
        @apply w-full py-3 px-4 bg-accent-btn text-white font-medium rounded-btn 
               shadow-btn hover:bg-accent-btn/90 active:bg-accent-btn/80 
               transition-all duration-200 focus:outline-none focus:ring-2 
               focus:ring-accent-btn/30 focus:border-accent-btn;
      }
      .custom-btn:disabled {
        @apply bg-text-disabled shadow-none cursor-not-allowed hover:bg-text-disabled;
      }
      
      .lock-grid {
        @apply grid grid-cols-[80px_1fr] gap-1 items-center text-base text-text-primary;
      }
      .lock-label { @apply text-right font-medium; }
      .lock-value { @apply text-left; }
      
      .result-table {
        @apply grid grid-cols-[1fr_1.3fr_1fr_1fr_1fr_1fr] gap-2 items-center text-sm text-text-primary;
      }
      .extra-table {
        @apply grid grid-cols-[1fr_1.3fr_1fr_1.2fr_1fr] gap-2 items-center text-sm text-text-primary;
      }
      .table-header {
        @apply font-medium pb-2 border-b border-secondary-200 text-center;
      }
      .table-row {
        @apply py-3 border-b border-secondary-200 last:border-0 text-center;
      }
      .table-cell {
        @apply whitespace-normal break-words text-balance;
      }
      
      .base-card {
        @apply bg-primary-100 rounded-card shadow-card p-4 transition-all duration-200;
      }
      .strategy-card {
        @apply bg-white rounded-card shadow-card p-4 transition-all duration-200 hover:shadow-hover;
      }
      
      .interactive {
        @apply transition-all duration-200 hover:bg-secondary-100;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans antialiased min-h-screen flex items-center justify-center p-4">
  <!-- 小程序设备外框：375×812主流手机尺寸 -->
  <div class="w-[375px] h-[812px] bg-primary-900 rounded-frame shadow-frame overflow-hidden relative">
    <!-- 内部独立滚动容器 -->
    <div class="w-full h-full overflow-y-auto scrollbar-hide bg-primary-100">
      <!-- 头部区域 -->
      <header class="bg-primary-800 py-5 px-6">
        <h1 class="font-title font-bold text-2xl text-white flex items-center gap-2">
          <i class="fa-solid fa-gem text-accent-main"></i>
          基质蚀刻工具
        </h1>
        <p class="text-xs text-gray-300 mt-1">明日方舟：终末地 · 裂隙刷取&基质匹配辅助</p>
      </header>

      <!-- 主内容区 -->
      <main class="px-6 py-5 space-y-6">
        <!-- 新增：基质词条反向匹配模块 -->
        <section class="base-card">
          <h2 class="section-title flex items-center gap-2">
            <i class="fa-solid fa-compass-drafting text-accent-btn"></i>
            基质词条匹配武器
          </h2>
          <div class="space-y-4">
            <select id="matchMainAttr" class="custom-select" disabled>
              <option value="" selected disabled>选择主属性词条</option>
            </select>
            <select id="matchSubAttr" class="custom-select" disabled>
              <option value="" selected disabled>选择副属性词条</option>
            </select>
            <select id="matchSkillAttr" class="custom-select" disabled>
              <option value="" selected disabled>选择技能词条</option>
            </select>
            <button id="matchBtn" class="custom-btn" disabled>一键匹配适配武器</button>
          </div>
          <!-- 匹配结果展示区 -->
          <div id="matchResultArea" class="mt-6 hidden">
            <h3 class="font-semibold text-base text-text-primary mb-3">匹配结果（共<span id="resultCount">0</span>把适配武器）</h3>
            <div id="matchResultContainer" class="space-y-2">
              <!-- 动态渲染匹配结果 -->
            </div>
          </div>
        </section>

        <!-- 原有：角色&武器选择模块 -->
        <section class="base-card">
          <h2 class="section-title flex items-center gap-2">
            <i class="fa-solid fa-user-gear text-accent-main"></i>
            选择角色与武器
          </h2>
          <select id="characterSelect" class="custom-select mb-4">
            <option value="" selected disabled>请选择角色</option>
          </select>
          <select id="weaponSelect" class="custom-select hidden" disabled>
            <option value="" selected disabled>请选择武器</option>
          </select>
        </section>

        <!-- 原有：武器&词条信息模块 -->
        <section id="weaponAttrSection" class="hidden base-card">
          <div class="mb-4">
            <h3 id="currentCharName" class="font-bold text-xl text-text-primary"></h3>
            <p id="currentWeaponName" class="text-sm mt-1 flex items-center gap-1">
              <i class="fa-solid fa-sword text-text-secondary"></i>
              <span id="weaponNameText"></span>
            </p>
            <!-- 武器类型展示 -->
            <p id="weaponTypeText" class="text-xs text-text-secondary mt-1 ml-6"></p>
          </div>
          <!-- 核心词条展示 -->
          <div class="grid grid-cols-3 gap-3 mt-5">
            <div class="interactive rounded-sm p-3 text-center">
              <p class="text-xs text-text-secondary mb-1">主属性</p>
              <p id="weaponMainAttr" class="tag-main font-bold"></p>
            </div>
            <div class="interactive rounded-sm p-3 text-center">
              <p class="text-xs text-text-secondary mb-1">副属性</p>
              <p id="weaponSubAttr" class="tag-sub font-bold"></p>
            </div>
            <div class="interactive rounded-sm p-3 text-center">
              <p class="text-xs text-text-secondary mb-1">技能词条</p>
              <p id="weaponSkillAttr" class="tag-skill font-bold"></p>
            </div>
          </div>
        </section>

        <!-- 原有：裂隙刷取策略模块 -->
        <section id="strategySection" class="hidden space-y-5">
          <h2 class="section-title flex items-center gap-2">
            <i class="fa-solid fa-map-location-dot text-accent-main"></i>
            裂隙刷取策略
          </h2>
          <div id="crackContainer" class="space-y-5">
            <!-- 动态渲染裂隙策略 -->
          </div>
        </section>
      </main>

      <!-- 页脚 -->
      <footer class="bg-primary-800 py-4 px-6 text-center text-xs text-gray-400 mt-6">
        <p>终末地工具集 · 仅供游戏交流</p>
      </footer>
    </div>
  </div>

  <script>
    // 【核心武器数据】主属性/副属性/技能/星级/武器类型
    const weaponDataMap = {
      "赫拉芬格": { main: "力量提升", extra: "攻击提升", skill: "迸发", star: 6, type: "双手剑" },
      "宏愿": { main: "敏捷提升", extra: "攻击提升", skill: "附术", star: 6, type: "单手剑" },
      "十二问": { main: "敏捷提升", extra: "攻击提升", skill: "附术", star: 5, type: "单手剑" },
      "黯色火炬": { main: "智识提升", extra: "灼热伤害提升", skill: "附术", star: 6, type: "单手剑" },
      "扶摇": { main: "主能力提升", extra: "暴击率提升", skill: "夜幕", star: 6, type: "单手剑" },
      "O.B.J.轻芒": { main: "敏捷提升", extra: "攻击提升", skill: "流转", star: 5, type: "单手剑" },
      "显赫声明": { main: "主能力提升", extra: "物理伤害提升", skill: "残暴", star: 6, type: "单手剑" },
      "白夜新星": { main: "主能力提升", extra: "源石技艺强度提升", skill: "附术", star: 6, type: "单手剑" },
      "使命必达": { main: "意志提升", extra: "终结技充能效率提升", skill: "追袭", star: 6, type: "施术单元" },
      "沧溟星梦": { main: "智识提升", extra: "治疗效率提升", skill: "附术", star: 6, type: "施术单元" },
      "作品：蚀迹": { main: "意志提升", extra: "自然伤害提升", skill: "压制", star: 6, type: "施术单元" },
      "爆破单元": { main: "主能力提升", extra: "源石技艺强度提升", skill: "迸发", star: 6, type: "施术单元" },
      "遗忘": { main: "智识提升", extra: "法术提升", skill: "夜幕", star: 6, type: "施术单元" },
      "骑士精神": { main: "意志提升", extra: "生命提升", skill: "医疗", star: 6, type: "施术单元" },
      "艺术暴君": { main: "智识提升", extra: "暴击率提升", skill: "切骨", star: 6, type: "手铳" },
      "领航者": { main: "智识提升", extra: "寒冷伤害提升", skill: "附术", star: 6, type: "手铳" },
      "楔子": { main: "主能力提升", extra: "暴击率提升", skill: "附术", star: 6, type: "手铳" },
      "同类相食": { main: "主能力提升", extra: "法术提升", skill: "附术", star: 6, type: "手铳" },
      "大雷斑": { main: "力量提升", extra: "生命提升", skill: "医疗", star: 6, type: "双手剑" },
      "不知归": { main: "意志提升", extra: "攻击提升", skill: "流转", star: 6, type: "单手剑" },
      "热熔切割器": { main: "意志提升", extra: "攻击提升", skill: "流转", star: 6, type: "单手剑" },
      "昔日精品": { main: "意志提升", extra: "生命提升", skill: "效益", star: 6, type: "双手剑" },
      "破碎君王": { main: "力量提升", extra: "暴击率提升", skill: "粉碎", star: 6, type: "双手剑" },
      "负山": { main: "敏捷提升", extra: "物理伤害提升", skill: "效益", star: 6, type: "长柄武器" },
      "骁勇": { main: "敏捷提升", extra: "物理伤害提升", skill: "巧技", star: 6, type: "长柄武器" },
      "熔铸火焰": { main: "智识提升", extra: "攻击提升", skill: "夜幕", star: 6, type: "单手剑" },
      "钢铁余音": { main: "敏捷提升", extra: "物理伤害提升", skill: "巧技", star: 5, type: "单手剑" },
      "坚城铸造者": { main: "智识提升", extra: "终结技充能效率提升", skill: "昂扬", star: 5, type: "单手剑" },
      "逐鳞3.0": { main: "力量提升", extra: "寒冷伤害提升", skill: "压制", star: 5, type: "单手剑" },
      "悼亡诗": { main: "智识提升", extra: "攻击提升", skill: "夜幕", star: 5, type: "施术单元" },
      "典范": { main: "主能力提升", extra: "攻击提升", skill: "压制", star: 6, type: "双手剑" },
      "仰止": { main: "敏捷提升", extra: "物理伤害提升", skill: "夜幕", star: 5, type: "单手剑" },
      "J.E.T.": { main: "主能力提升", extra: "攻击提升", skill: "压制", star: 6, type: "长柄武器" },
      "莫奈何": { main: "意志提升", extra: "终结技充能效率提升", skill: "昂扬", star: 5, type: "施术单元" },
      "迷失荒野": { main: "智识提升", extra: "电磁伤害提升", skill: "附术", star: 5, type: "施术单元" },
      "布道自由": { main: "意志提升", extra: "治疗效率提升", skill: "医疗", star: 5, type: "施术单元" },
      "O.B.J.术识": { main: "智识提升", extra: "源石技艺强度提升", skill: "追袭", star: 5, type: "施术单元" },
      "作品：众生": { main: "敏捷提升", extra: "法术提升", skill: "附术", star: 5, type: "手铳" },
      "O.B.J.迅极": { main: "敏捷提升", extra: "终结技充能效率提升", skill: "迸发", star: 5, type: "手铳" },
      "理性告别": { main: "力量提升", extra: "灼热伤害提升", skill: "追袭", star: 5, type: "手铳" },
      "探骊": { main: "力量提升", extra: "终结技充能效率提升", skill: "迸发", star: 5, type: "双手剑" },
      "古渠": { main: "力量提升", extra: "源石技艺强度提升", skill: "残暴", star: 5, type: "双手剑" },
      "终点之声": { main: "力量提升", extra: "生命提升", skill: "医疗", star: 5, type: "双手剑" },
      "O.B.J.重荷": { main: "力量提升", extra: "生命提升", skill: "效益", star: 5, type: "双手剑" },
      "嵌合正义": { main: "力量提升", extra: "终结技充能效率提升", skill: "残暴", star: 5, type: "长柄武器" },
      "O.B.J.尖峰": { main: "意志提升", extra: "物理伤害提升", skill: "附术", star: 5, type: "长柄武器" },
      "向心之引": { main: "意志提升", extra: "电磁伤害提升", skill: "压制", star: 5, type: "长柄武器" }
    };

    // 角色-武器关联数据
    const characterData = {
      admin: { name: "管理员", base: "敏捷提升", weapons: ["宏愿", "坚城铸造者", "显赫声明", "钢铁余音"] },
      peilika: { name: "佩丽卡", base: "主能力提升", weapons: ["爆破单元", "迷失荒野", "遗忘", "悼亡诗"] },
      chenqianyu: { name: "陈千语", base: "主能力提升", weapons: ["扶摇", "钢铁余音", "仰止", "莫奈何"] },
      laiwanting: { name: "莱万汀", base: "智识提升", weapons: ["熔铸火焰", "黯色火炬", "白夜新星", "悼亡诗"] },
      yifeng: { name: "伊冯", base: "智识提升", weapons: ["艺术暴君", "领航者", "楔子", "作品：众生"] },
      jieerpeita: { name: "洁尔佩塔", base: "意志提升", weapons: ["使命必达", "作品：蚀迹", "莫奈何"] },
      aierdaila: { name: "艾尔黛拉", base: "智识提升", weapons: ["沧溟星梦"] },
      yujin: { name: "余烬", base: "力量提升", weapons: ["大雷斑", "终点之声"] },
      bieli: { name: "别礼", base: "力量提升", weapons: ["赫拉芬格", "破碎君王", "探骊", "嵌合正义"] },
      lifeng: { name: "黎风", base: "敏捷提升", weapons: ["负山", "骁勇", "J.E.T.", "钢铁余音"] },
      junwei: { name: "骏卫", base: "意志提升", weapons: ["不知归", "热熔切割器", "显赫声明", "昔日精品"] },
      alieshi: { name: "阿列什", base: "力量提升", weapons: ["逐鳞3.0"] },
      huguang: { name: "弧光", base: "敏捷提升", weapons: ["十二问", "O.B.J.轻芒"] },
      aiweiwenna: { name: "艾维文娜", base: "主能力提升", weapons: ["J.E.T.", "向心之引", "典范"] },
      dapan: { name: "大潘", base: "主能力提升", weapons: ["典范", "古渠"] },
      zhouxue: { name: "昼雪", base: "力量提升", weapons: ["终点之声", "O.B.J.重荷", "大雷斑"] },
      langwei: { name: "狼卫", base: "主能力提升", weapons: ["同类相食", "理性告别", "楔子"] },
      saixi: { name: "塞希", base: "意志提升", weapons: ["骑士精神", "布道自由", "O.B.J.尖峰"] },
      qiuli: { name: "秋栗", base: "敏捷提升", weapons: ["热熔切割器", "O.B.J.轻芒", "十二问"] },
      antaer: { name: "安塔尔", base: "智识提升", weapons: ["O.B.J.术识", "迷失荒野"] },
      kaqier: { name: "卡契尔", base: "力量提升", weapons: ["O.B.J.重荷", "古渠"] },
      aitela: { name: "埃特拉", base: "意志提升", weapons: ["O.B.J.尖峰", "作品：蚀迹"] },
      yingshi: { name: "萤石", base: "敏捷提升", weapons: ["O.B.J.迅极", "负山"] }
    };

    // 裂隙数据：适配所有武器词条
    const crackData = {
      crack1: {
        name: "枢纽区",
        baseList: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extraList: ["攻击提升", "灼热伤害提升", "电磁伤害提升", "寒冷伤害提升", "自然伤害提升", "源石技艺强度提升", "终结技充能效率提升", "法术提升"],
        skillList: ["强攻", "压制", "追袭", "粉碎", "巧技", "迸发", "流转", "效益", "残暴"]
      },
      crack2: {
        name: "源石研究院",
        baseList: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extraList: ["攻击提升", "物理伤害提升", "电磁伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "终结技充能效率提升", "法术提升"],
        skillList: ["压制", "追袭", "昂扬", "巧技", "附术", "医疗", "切骨", "效益", "残暴"]
      },
      crack3: {
        name: "矿脉源区",
        baseList: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extraList: ["生命提升", "物理伤害提升", "灼热伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "源石技艺强度提升", "治疗效率提升"],
        skillList: ["强攻", "压制", "巧技", "残暴", "附术", "迸发", "夜幕", "效益", "粉碎"]
      },
      crack4: {
        name: "供能高地",
        baseList: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extraList: ["攻击提升", "生命提升", "物理伤害提升", "灼热伤害提升", "自然伤害提升", "暴击率提升", "源石技艺强度提升", "治疗效率提升"],
        skillList: ["追袭", "粉碎", "昂扬", "残暴", "附术", "医疗", "切骨", "流转", "巧技"]
      },
      crack5: {
        name: "武陵城",
        baseList: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
        extraList: ["攻击提升", "生命提升", "电磁伤害提升", "寒冷伤害提升", "暴击率提升", "终结技充能效率提升", "法术提升", "治疗效率提升"],
        skillList: ["强攻", "粉碎", "残暴", "医疗", "切骨", "迸发", "夜幕", "流转", "昂扬"]
      }
    };

    // 提取所有唯一词条（用于基质匹配选择框）
    const allAttrs = {
      main: [...new Set(Object.values(crackData).flatMap(c => c.baseList))].sort(),
      extra: [...new Set(Object.values(crackData).flatMap(c => c.extraList))].sort(),
      skill: [...new Set(Object.values(crackData).flatMap(c => c.skillList))].sort()
    };

    // 武器星级配置：从weaponDataMap自动提取
    const weaponStarConfig = {
      6: Object.entries(weaponDataMap).filter(([_, data]) => data.star === 6).map(([name, _]) => name),
      5: Object.entries(weaponDataMap).filter(([_, data]) => data.star === 5).map(([name, _]) => name)
    };

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // === 新功能：基质匹配 DOM元素 ===
      const matchMainAttr = document.getElementById('matchMainAttr');
      const matchSubAttr = document.getElementById('matchSubAttr');
      const matchSkillAttr = document.getElementById('matchSkillAttr');
      const matchBtn = document.getElementById('matchBtn');
      const matchResultArea = document.getElementById('matchResultArea');
      const matchResultContainer = document.getElementById('matchResultContainer');
      const resultCount = document.getElementById('resultCount');

      // === 原有功能 DOM元素 ===
      const characterSelect = document.getElementById('characterSelect');
      const weaponSelect = document.getElementById('weaponSelect');
      const weaponAttrSection = document.getElementById('weaponAttrSection');
      const strategySection = document.getElementById('strategySection');
      const currentCharName = document.getElementById('currentCharName');
      const weaponNameText = document.getElementById('weaponNameText');
      const weaponTypeText = document.getElementById('weaponTypeText');
      const weaponMainAttr = document.getElementById('weaponMainAttr');
      const weaponSubAttr = document.getElementById('weaponSubAttr');
      const weaponSkillAttr = document.getElementById('weaponSkillAttr');
      const crackContainer = document.getElementById('crackContainer');

      // 工具函数：判断武器星级，返回对应样式类
      function getWeaponStarClass(weaponName) {
        if (weaponStarConfig[6].includes(weaponName)) return 'weapon-6';
        if (weaponStarConfig[5].includes(weaponName)) return 'weapon-5';
        return 'text-text-secondary';
      }

      // 工具函数：通过武器名获取完整武器数据
      function getWeaponFullData(weaponName) {
        return weaponDataMap[weaponName] || {};
      }

      // 工具函数：通过武器名获取所属所有角色
      function getWeaponBelongChars(weaponName) {
        return Object.entries(characterData)
          .filter(([_, char]) => char.weapons.includes(weaponName))
          .map(([_, char]) => char.name)
          .join(' / ') || '未知角色';
      }

      // === 新功能：初始化基质匹配词条选择框 ===
      function initMatchSelects() {
        // 渲染主属性选择框
        allAttrs.main.forEach(attr => {
          const option = document.createElement('option');
          option.value = attr;
          option.textContent = attr;
          matchMainAttr.appendChild(option);
        });
        // 渲染副属性选择框
        allAttrs.extra.forEach(attr => {
          const option = document.createElement('option');
          option.value = attr;
          option.textContent = attr;
          matchSubAttr.appendChild(option);
        });
        // 渲染技能词条选择框
        allAttrs.skill.forEach(attr => {
          const option = document.createElement('option');
          option.value = attr;
          option.textContent = attr;
          matchSkillAttr.appendChild(option);
        });
        // 启用选择框
        matchMainAttr.disabled = false;
        matchSubAttr.disabled = false;
        matchSkillAttr.disabled = false;
      }

      // === 新功能：检查是否可点击匹配按钮 ===
      function checkMatchBtnEnable() {
        const hasMain = !!matchMainAttr.value;
        const hasSub = !!matchSubAttr.value;
        const hasSkill = !!matchSkillAttr.value;
        matchBtn.disabled = !(hasMain && hasSub && hasSkill);
      }

      // === 新功能：基质词条匹配武器核心逻辑 ===
      function matchWeaponByAttrs() {
        // 清空上一次结果
        matchResultContainer.innerHTML = '';
        matchResultArea.classList.remove('hidden');
        // 获取选择的词条
        const selectMain = matchMainAttr.value;
        const selectSub = matchSubAttr.value;
        const selectSkill = matchSkillAttr.value;
        // 筛选匹配的武器
        const matchWeapons = Object.entries(weaponDataMap)
          .filter(([weaponName, weaponData]) => {
            return weaponData.main === selectMain &&
                   weaponData.extra === selectSub &&
                   weaponData.skill === selectSkill;
          })
          .map(([weaponName, weaponData]) => ({
            name: weaponName,
            ...weaponData,
            belongChars: getWeaponBelongChars(weaponName)
          }));
        // 更新结果数量
        resultCount.textContent = matchWeapons.length;
        // 渲染匹配结果
        if (matchWeapons.length === 0) {
          matchResultContainer.innerHTML = `
            <div class="text-sm text-text-secondary text-center py-4">
              暂无适配该词条组合的武器
            </div>
          `;
          return;
        }
        // 渲染结果表格头部
        const tableHeader = document.createElement('div');
        tableHeader.className = 'result-table table-header';
        tableHeader.innerHTML = `
          <div class="table-cell">角色</div>
          <div class="table-cell">武器</div>
          <div class="table-cell">类型</div>
          <div class="table-cell">主属性</div>
          <div class="table-cell">副属性</div>
          <div class="table-cell">技能</div>
        `;
        matchResultContainer.appendChild(tableHeader);
        // 渲染每一条匹配结果
        matchWeapons.forEach(weapon => {
          const tableRow = document.createElement('div');
          tableRow.className = 'result-table table-row';
          tableRow.innerHTML = `
            <div class="table-cell">${weapon.belongChars}</div>
            <div class="table-cell ${getWeaponStarClass(weapon.name)}">${weapon.name}</div>
            <div class="table-cell">${weapon.type}</div>
            <div class="table-cell tag-main">${weapon.main}</div>
            <div class="table-cell tag-sub">${weapon.extra}</div>
            <div class="table-cell tag-skill">${weapon.skill}</div>
          `;
          matchResultContainer.appendChild(tableRow);
        });
        // 平滑滚动到结果区
        matchResultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // === 原有功能：初始化角色选择下拉框 ===
      function initCharacterSelect() {
        Object.entries(characterData).forEach(([key, char]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = char.name;
          characterSelect.appendChild(option);
        });
      }

      // === 原有功能：根据选中角色加载武器列表（带星级颜色） ===
      function loadWeaponsByChar(charKey) {
        weaponSelect.innerHTML = '<option value="" selected disabled>请选择武器</option>';
        const targetChar = characterData[charKey];
        targetChar.weapons.forEach((weaponName, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = weaponName;
          option.className = getWeaponStarClass(weaponName);
          weaponSelect.appendChild(option);
        });
        weaponSelect.classList.remove('hidden');
        weaponSelect.disabled = false;
      }

      // === 原有功能：渲染武器与词条信息（带星级/类型） ===
      function renderWeaponAttr(charKey, weaponIndex) {
        const targetChar = characterData[charKey];
        const weaponName = targetChar.weapons[weaponIndex];
        const weaponData = getWeaponFullData(weaponName);
        
        // 填充基础信息
        currentCharName.textContent = targetChar.name;
        weaponNameText.textContent = weaponName;
        weaponNameText.className = getWeaponStarClass(weaponName);
        weaponTypeText.textContent = `武器类型：${weaponData.type || '未知'}`;
        
        // 填充词条信息
        weaponMainAttr.textContent = weaponData.main || '';
        weaponSubAttr.textContent = weaponData.extra || '';
        weaponSkillAttr.textContent = weaponData.skill || '';
        
        weaponAttrSection.classList.remove('hidden');
      }

      // === 原有功能：生成不重复的3个主属性（用于策略筛选） ===
      function getUniqueLockMain(targetBase, crackBaseList) {
        const lockMain = [targetBase];
        const otherMains = crackBaseList.filter(attr => attr !== targetBase);
        lockMain.push(...otherMains.slice(0, 2));
        return lockMain;
      }

      // === 原有功能：筛选顺带产出的武器 ===
      function getExtraWeapons(targetWeaponData, crack) {
        const targetMain = targetWeaponData.main;
        const targetExtra = targetWeaponData.extra;
        const targetSkill = targetWeaponData.skill;
        
        return Object.entries(weaponDataMap).flatMap(([weaponName, weaponData]) => {
          if (weaponName === targetWeaponData.name) return [];
          const mainMatch = getUniqueLockMain(targetMain, crack.baseList).includes(weaponData.main);
          const extraMatch = crack.extraList.includes(weaponData.extra);
          const skillMatch = crack.skillList.includes(weaponData.skill);
          const crackMainMatch = crack.baseList.includes(weaponData.main);
          const crackExtraMatch = crack.extraList.includes(weaponData.extra);
          const crackSkillMatch = crack.skillList.includes(weaponData.skill);
          
          if (mainMatch && (extraMatch || skillMatch) && crackMainMatch && crackExtraMatch && crackSkillMatch) {
            const charName = Object.entries(characterData).find(([_, char]) => char.weapons.includes(weaponName))?.[1]?.name || '未知角色';
            return [{ ...weaponData, name: weaponName, charName }];
          }
          return [];
        });
      }

      // === 原有功能：渲染裂隙刷取策略 ===
      function renderStrategies(charKey, weaponIndex) {
        crackContainer.innerHTML = '';
        const targetChar = characterData[charKey];
        const weaponName = targetChar.weapons[weaponIndex];
        const targetWeaponData = { ...getWeaponFullData(weaponName), name: weaponName };
        
        // 筛选匹配当前武器词条的裂隙
        const matchCracks = Object.values(crackData).filter(crack => 
          crack.baseList.includes(targetWeaponData.main) &&
          crack.extraList.includes(targetWeaponData.extra) &&
          crack.skillList.includes(targetWeaponData.skill)
        );

        // 渲染每个匹配的裂隙
        matchCracks.forEach(crack => {
          const lockMain = getUniqueLockMain(targetWeaponData.main, crack.baseList);
          // 定义两种刷取方案
          const strategies = [
            {
              type: "extra",
              name: "锁定副属性",
              icon: "fa-solid fa-star",
              lockMain: lockMain,
              lockVal: targetWeaponData.extra,
              extraList: getExtraWeapons(targetWeaponData, crack).filter(w => w.extra === targetWeaponData.extra)
            },
            {
              type: "skill",
              name: "锁定技能词条",
              icon: "fa-solid fa-wand-magic-sparkles",
              lockMain: lockMain,
              lockVal: targetWeaponData.skill,
              extraList: getExtraWeapons(targetWeaponData, crack).filter(w => w.skill === targetWeaponData.skill)
            }
          ];

          // 创建裂隙卡片
          const crackCard = document.createElement('div');
          crackCard.className = "base-card";
          crackCard.innerHTML = `
            <h3 class="card-title flex items-center gap-2">
              <i class="fa-solid fa-location-dot text-accent-main"></i>
              裂隙：${crack.name}
            </h3>
            <div class="grid grid-cols-1 gap-4">
              ${strategies.map((strategy, index) => {
                const mainAttrHtml = strategy.lockMain.map(item => `<span class="tag-main">${item}</span>`).join('、');
                // 生成锁定信息HTML
                const lockHtml = strategy.type === 'extra' ? `
                  <div class="lock-grid">
                    <div class="lock-label">主属性：</div>
                    <div class="lock-value">${mainAttrHtml}</div>
                  </div>
                  <div class="lock-grid">
                    <div class="lock-label">副属性：</div>
                    <div class="lock-value"><span class="tag-sub">${strategy.lockVal}</span>（必出）</div>
                  </div>
                  <div class="lock-grid">
                    <div class="lock-label">技能词条：</div>
                    <div class="lock-value">随机</div>
                  </div>
                ` : `
                  <div class="lock-grid">
                    <div class="lock-label">主属性：</div>
                    <div class="lock-value">${mainAttrHtml}</div>
                  </div>
                  <div class="lock-grid">
                    <div class="lock-label">副属性：</div>
                    <div class="lock-value">随机</div>
                  </div>
                  <div class="lock-grid">
                    <div class="lock-label">技能词条：</div>
                    <div class="lock-value"><span class="tag-skill">${strategy.lockVal}</span>（必出）</div>
                  </div>
                `;
                // 生成顺带产出HTML（武器带星级颜色）
                const extraHtml = strategy.extraList.length === 0 ? 
                  '<div class="text-sm text-text-secondary text-center py-3">暂无顺带产出武器</div>' : 
                  `
                    <div class="extra-table table-header">
                      <div class="table-cell">角色</div>
                      <div class="table-cell">武器</div>
                      <div class="table-cell">主属性</div>
                      <div class="table-cell">副属性</div>
                      <div class="table-cell">技能</div>
                    </div>
                    ${strategy.extraList.map(item => {
                      const weaponStarClass = getWeaponStarClass(item.name);
                      return `
                        <div class="extra-table table-row">
                          <div class="table-cell">${item.charName}</div>
                          <div class="table-cell ${weaponStarClass}">${item.name}</div>
                          <div class="table-cell tag-main">${item.main}</div>
                          <div class="table-cell tag-sub">${item.extra}</div>
                          <div class="table-cell tag-skill">${item.skill}</div>
                        </div>
                      `;
                    }).join('')}
                  `;

                // 生成方案卡片
                return `
                  <div class="strategy-card">
                    <h4 class="strategy-title">
                      <span class="inline-block w-6 h-6 rounded-full bg-primary-800 text-white text-xs flex items-center justify-center">${index+1}</span>
                      <i class="${strategy.icon} text-accent-main"></i>
                      ${strategy.name}
                    </h4>
                    <div class="mb-4">${lockHtml}</div>
                    <div class="mt-4">
                      <p class="text-sm font-medium text-text-primary mb-2">顺带产出武器</p>
                      ${extraHtml}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
          crackContainer.appendChild(crackCard);
        });

        // 显示策略区域并平滑滚动
        strategySection.classList.remove('hidden');
        strategySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // === 事件绑定 ===
      // 新功能：词条选择框变更，检查按钮状态
      matchMainAttr.addEventListener('change', checkMatchBtnEnable);
      matchSubAttr.addEventListener('change', checkMatchBtnEnable);
      matchSkillAttr.addEventListener('change', checkMatchBtnEnable);
      // 新功能：点击匹配按钮
      matchBtn.addEventListener('click', matchWeaponByAttrs);
      // 原有功能：角色选择变更
      characterSelect.addEventListener('change', function() {
        const charKey = this.value;
        if (!charKey) return;
        loadWeaponsByChar(charKey);
        weaponSelect.value = '';
        weaponAttrSection.classList.add('hidden');
        strategySection.classList.add('hidden');
      });
      // 原有功能：武器选择变更
      weaponSelect.addEventListener('change', function() {
        const weaponIndex = this.value;
        const charKey = characterSelect.value;
        if (!charKey || !weaponIndex) return;
        renderWeaponAttr(charKey, weaponIndex);
        renderStrategies(charKey, weaponIndex);
      });

      // === 初始化执行 ===
      initMatchSelects(); // 新功能初始化
      initCharacterSelect(); // 原有功能初始化
    });
  </script>
</body>
</html>